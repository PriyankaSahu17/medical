import { BSON, type Document } from 'bson';

import { ns } from '../../../utils';
import type { Connection } from '../../connection';
import type { MongoCredentials } from '../mongo_credentials';
<<<<<<< HEAD
import { AuthMechanism } from '../providers';
import type { Workflow } from './workflow';
=======
import type { Workflow } from '../mongodb_oidc';
import { AuthMechanism } from '../providers';
>>>>>>> fbc8dfd1dc1e8142d05458c7d646053f0b1a6dbf

/**
 * Common behaviour for OIDC device workflows.
 * @internal
 */
export abstract class ServiceWorkflow implements Workflow {
  /**
   * Execute the workflow. Looks for AWS_WEB_IDENTITY_TOKEN_FILE in the environment
   * and then attempts to read the token from that path.
   */
  async execute(connection: Connection, credentials: MongoCredentials): Promise<Document> {
<<<<<<< HEAD
    const token = await this.getToken();
=======
    const token = await this.getToken(credentials);
>>>>>>> fbc8dfd1dc1e8142d05458c7d646053f0b1a6dbf
    const command = commandDocument(token);
    return connection.commandAsync(ns(credentials.source), command, undefined);
  }

  /**
   * Get the document to add for speculative authentication.
   */
<<<<<<< HEAD
  async speculativeAuth(): Promise<Document> {
    const token = await this.getToken();
    return { speculativeAuthenticate: commandDocument(token) };
=======
  async speculativeAuth(credentials: MongoCredentials): Promise<Document> {
    const token = await this.getToken(credentials);
    const document = commandDocument(token);
    document.db = credentials.source;
    return { speculativeAuthenticate: document };
>>>>>>> fbc8dfd1dc1e8142d05458c7d646053f0b1a6dbf
  }

  /**
   * Get the token from the environment or endpoint.
   */
<<<<<<< HEAD
  abstract getToken(): Promise<string>;
=======
  abstract getToken(credentials: MongoCredentials): Promise<string>;
>>>>>>> fbc8dfd1dc1e8142d05458c7d646053f0b1a6dbf
}

/**
 * Create the saslStart command document.
 */
export function commandDocument(token: string): Document {
  return {
    saslStart: 1,
    mechanism: AuthMechanism.MONGODB_OIDC,
    payload: BSON.serialize({ jwt: token })
  };
}
